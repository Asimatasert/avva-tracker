<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AVVA Fırsat Merkezi</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="/" class="nav-brand">AVVA Tracker</a>
      <div class="nav-links">
        <a href="/" class="active">Fırsat Merkezi</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-value"><%= pagination.total %></span>
        <span class="stat-label">Toplam Ürün</span>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <form action="/" method="GET" class="filters-form">
        <div class="filter-group">
          <input type="text" name="search" placeholder="Ürün ara..."
                 value="<%= filters.search %>" class="filter-input">
        </div>

        <div class="filter-group">
          <select name="category" class="filter-select">
            <option value="">Tüm Kategoriler</option>
            <% categories.forEach(cat => { %>
              <option value="<%= cat.id %>" <%= filters.category == cat.id ? 'selected' : '' %>><%= cat.name %></option>
            <% }) %>
          </select>
        </div>

        <div class="filter-group">
          <select name="sort" class="filter-select">
            <option value="price_asc" <%= filters.sort === 'price_asc' ? 'selected' : '' %>>Fiyat (Artan)</option>
            <option value="price_desc" <%= filters.sort === 'price_desc' ? 'selected' : '' %>>Fiyat (Azalan)</option>
            <option value="newest" <%= filters.sort === 'newest' ? 'selected' : '' %>>En Yeni</option>
          </select>
        </div>

        <button type="submit" class="filter-btn">Filtrele</button>
        <a href="/" class="filter-btn secondary">Temizle</a>
      </form>

      <div class="view-toggle">
        <button class="view-btn active" data-view="grid" title="Grid">&#9638;</button>
        <button class="view-btn" data-view="list" title="Liste">&#9776;</button>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="products-grid">
      <% if (products.length === 0) { %>
        <div class="no-results">
          <p>Ürün bulunamadı</p>
        </div>
      <% } %>

      <% products.forEach(product => { %>
        <div class="product-card">
          <div class="product-image">
            <% if (product.image_url) { %>
              <img src="<%= product.image_url %>" alt="<%= product.name %>" loading="lazy">
            <% } else { %>
              <div class="no-image">AVVA</div>
            <% } %>
          </div>

          <div class="product-info">
            <div class="product-category"><%= product.category_name || 'Genel' %></div>
            <h3 class="product-name">
              <a href="/product/<%= product.id %>"><%= product.name %></a>
            </h3>
            <div class="product-code"><%= product.base_code %></div>

            <div class="product-prices">
              <span class="current-price"><%= formatPrice(product.current_price) %></span>
            </div>

            <% if (product.variant_count > 1) { %>
              <div class="color-variants">
                <% product.variants.slice(0, 6).forEach(v => { %>
                  <a href="/product/<%= v.id %>" class="variant-dot" title="<%= v.color_code %>">
                    <% if (v.image_url) { %>
                      <img src="<%= v.image_url %>" alt="<%= v.color_code %>">
                    <% } %>
                  </a>
                <% }) %>
                <% if (product.variant_count > 6) { %>
                  <span class="more-variants">+<%= product.variant_count - 6 %></span>
                <% } %>
              </div>
            <% } %>

            <div class="product-meta">
              <span class="stock-status <%= product.in_stock ? 'in-stock' : 'out-stock' %>">
                <%= product.in_stock ? 'Stokta' : 'Tükendi' %>
              </span>
              <% if (product.variant_count > 1) { %>
                <span class="variant-count"><%= product.variant_count %> renk</span>
              <% } %>
            </div>

            <a href="/product/<%= product.id %>" class="detail-btn">Detay</a>
          </div>
        </div>
      <% }) %>
    </div>

    <!-- Pagination -->
    <% if (pagination.totalPages > 1) { %>
      <div class="pagination">
        <% if (pagination.page > 1) { %>
          <a href="?page=<%= pagination.page - 1 %>&sort=<%= filters.sort %>&category=<%= filters.category %>&search=<%= filters.search %>" class="page-btn">&laquo; Önceki</a>
        <% } %>

        <span class="page-info">Sayfa <%= pagination.page %> / <%= pagination.totalPages %></span>

        <% if (pagination.page < pagination.totalPages) { %>
          <a href="?page=<%= pagination.page + 1 %>&sort=<%= filters.sort %>&category=<%= filters.category %>&search=<%= filters.search %>" class="page-btn">Sonraki &raquo;</a>
        <% } %>
      </div>
    <% } %>
  </main>

  <footer class="footer">
    <p>AVVA Fiyat Takip Sistemi</p>
  </footer>

  <script>
    document.querySelectorAll('.view-toggle .view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-toggle .view-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const view = btn.dataset.view;
        const grid = document.querySelector('.products-grid');
        grid.classList.toggle('list-view', view === 'list');
        localStorage.setItem('viewMode', view);
      });
    });
    // Restore view mode
    const savedView = localStorage.getItem('viewMode');
    if (savedView === 'list') {
      document.querySelector('.products-grid').classList.add('list-view');
      document.querySelector('[data-view="list"]').classList.add('active');
      document.querySelector('[data-view="grid"]').classList.remove('active');
    }
  </script>
</body>
</html>
